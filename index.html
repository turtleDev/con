<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Life</title>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            background: #262B35;
        }

        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .title {
            color: #696773;
            font-family: monospace;
            font-weight: bold;
            text-align: center;
        }

        .header {
            position: relative;
            width: 400px;
        }

        .generation {
            position: absolute;
            right: 5px;
            bottom: 5px;
            font-family: monospace;
            color: #696773;
        }

        #reset-btn {
            margin-top: 30px;
            padding: 10px 20px;
            font-size: 18px;
            font-weight: bold;
            border: 0;
            font-family: monospace;
            color: #696773;
            background: #E2856E;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1 class="title">Life</h1>
        <div class="generation">
            <span>Generation:</span>
            <span class="generation-id">0</span>
        </div>
    </div>
    <canvas id="main">
        <!-- fallback -->
        <p>
            your browser does not support html5 canvas. tough luck.
        </p>
    </canvas>
    <button id="reset-btn">Reset?</button>
</body>
<script>
    (function () {
        "use strict";

        /**
         * Cell represents an individual cell in the world.
         */
        class Cell {
            constructor(isAlive = false) {
                this.isAlive = isAlive;
            }
        }

        /**
         * World represents the world that cells reside in
         */
        class World {

            // construct a new world of X by Y dimensions
            constructor(cells, x = 10, y = 10) {
                this._x = x;
                this._y = y;
                if (Array.isArray(cells)) {
                    this._cells = cells;
                } else {
                    this._cells = Array(x * y).fill(0).map(_ => {
                        let isAlive = Math.random() > 0.5;
                        return new Cell(isAlive);
                    });
                }
            }

            // advances the time in the world, producing a new world 
            // that contains the evolution of the previous world
            // TODO(turtledev): find a better name for this operation
            next() {
                let liveCell = new Cell(true);
                let deadCell = new Cell(false);

                let cells = this._cells.map((cell, idx, previousCells) => {
                    let x = idx % this._x;
                    let y = Math.floor(idx / this._y);
                    let liveNeighbours = this._getLiveNeighborsOf(x, y)

                    if ( !cell.isAlive && liveNeighbours === 3 ) {
                        return liveCell;
                    }

                    if ( cell.isAlive && (liveNeighbours < 2 || liveNeighbours > 3) ) {
                        return deadCell;
                    }

                    return cell;
                });

                return new World(cells, this._x, this._y);
            }

            _getLiveNeighborsOf(x, y) {
                let neighborOffsets = [
                    [-1, 0], // left
                    [-1, -1], // top left
                    [ 0, -1], // top
                    [1, -1], // top right
                    [1, 0], // right
                    [1, 1], // bottom right
                    [0, 1], // bottom
                    [-1, 1], // bottom left
                ];

                let liveNeighbours = 0;
                for ( let [offsetX, offsetY] of neighborOffsets ) {
                    if (this._getCell(x + offsetX, y + offsetY).isAlive) {
                        liveNeighbours++;
                    }
                }
                return liveNeighbours;
            }

            _normalise(value, max) {
                if (value < 0) {
                    while (value < 0) {
                        value = max + value;
                    }
                    return value;
                }
                return value % max;
            }

            _getCell(x, y) {
                // sanitise X to the range [0, this._x)
                // and Y to range (0, this._y]
                x = this._normalise(x, this._x);
                y = this._normalise(y, this._y);
                let cellIdx = (y * this._x) + x;
                return this._cells[cellIdx];
            }

            render(renderer) {
                renderer.clear();
                renderer.setBounds(this._x, this._y);
                for (let i = 0; i < this._x; i++) {
                    for (let j = 0; j < this._y; j++) {
                        if (this._getCell(i, j).isAlive) {
                            renderer.setCellAlive(i, j);
                        }
                    }
                }
            }
        }

        /**
         * Renderer is an interface for a surface that can be rendered to
         */
        class Renderer {
            clear() { }
            setBounds(x, y) { }
            setCellAlive(x, y, isAlive) { }
        }

        /**
         * CanvasRenderer implements Renderer to a canvas element
         */
        class CanvasRenderer extends Renderer {

            constructor(el, config = {}) {
                super();

                // obtain a reference to the DOM canvas;
                this._el = document.querySelector(el);
                if (!this._el.getContext) {
                    throw new Error("unable to acquire Canvas context")
                }

                // the dimensions of the rendering surface
                this._width = config.width || 200;
                this._height = config.height || 200;
                this._el.width = this._width;
                this._el.height = this._height;

                // reference to the rendering context
                this._ctx = this._el.getContext("2d");

                // drawing configuration
                this._bgColor = config.background || "#696773";
                this._fgColor = config.foreground || "#E2856E";

                // the dimensions of the world; set via setBounds method
                this._worldWidth = undefined;
                this._worldHeight = undefined;

                // paint the background
                this.clear();
            }

            clear() {
                this._ctx.fillStyle = this._bgColor;
                this._ctx.fillRect(0, 0, this._width, this._height);

                this._worldWidth = undefined;
                this._worldHeight = undefined;
            }

            setBounds(x, y) {
                this._worldWidth = x;
                this._worldHeight = y;
            }

            setCellAlive(x, y) {
                if (!this._worldHeight || !this._worldWidth) {
                    throw new Error("world bounds are unset. please call 'setBounds' before the first call to 'setCell'");
                }

                // compute the dimensions of the cells
                let cellWidth = Math.floor(this._width / this._worldWidth);
                let cellHeight = Math.floor(this._height / this._worldHeight);

                // render the cell
                this._ctx.fillStyle = this._fgColor;
                this._ctx.fillRect(x * cellWidth, y * cellHeight, cellWidth, cellHeight);
            }
        }


        // a setup IIFE that returns a function that can
        // be used to reset the world state
        let toggle = (function setup() {

            const WORLD_HEIGHT = 100;
            const WORLD_WIDTH = 100;
            const CANVAS_HEIGHT = 400;
            const CANVAS_WIDTH = 400;

            let worldMap = [
                "....................................................................................................",
                ".........................=..........................................................................",
                ".......................=.=..........................................................................",
                ".............==......==............==...............................................................",
                "............=...=....==............==...............................................................",
                ".==........=.....=...==.............................................................................",
                ".==........=...=.==....=.=..........................................................................",
                "...........=.....=.......=..........................................................................",
                "............=...=...................................................................................",
                ".............==.....................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
                "....................................................................................................",
            ];

            let deadCell = new Cell(false);
            let liveCell = new Cell(true);
            worldMap = worldMap.join("")
                .split("")
                .map(v => v === "." ? deadCell : liveCell);

            let renderer = new CanvasRenderer("#main", { width: CANVAS_WIDTH, height: CANVAS_HEIGHT });
            let world = new World(worldMap, WORLD_WIDTH, WORLD_HEIGHT);

            let generation = 0;
            let generationLabel = document.querySelector(".generation .generation-id")


            function update() {
                generation++;
                generationLabel.innerHTML = generation;
                world = world.next();
                world.render(renderer);
            }
            setInterval(update, 50);

            return function() {
                world = new World(null, WORLD_WIDTH, WORLD_HEIGHT);
                generation = 0;
            }
        })()


        document.querySelector("#reset-btn").addEventListener("click", toggle);
    })()
</script>

</html>